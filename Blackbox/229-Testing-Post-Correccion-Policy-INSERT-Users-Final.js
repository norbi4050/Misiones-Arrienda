// ============================================================
// TESTING POST-CORRECCI√ìN: POL√çTICA INSERT USERS
// ============================================================
// Verifica que el error "Database error saving new user" est√© resuelto
// ============================================================

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');

// Configuraci√≥n de Supabase con credenciales reales
const SUPABASE_URL = 'https://pqmjfwmbitodwtpedlle.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbWpmd21iaXRvZHd0cGVkbGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5Mzg2NzEsImV4cCI6MjA1MTUxNDY3MX0.lpIJLwNw_3_0xJGBXJJELJKYKDnEKhfJrOdwYJqOqAI';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log('üß™ TESTING POST-CORRECCI√ìN: POL√çTICA INSERT USERS');
console.log('============================================================\n');

async function testingPostCorreccion() {
    const reporte = {
        timestamp: new Date().toISOString(),
        proceso: 'Testing Post-Correcci√≥n Pol√≠tica INSERT Users',
        tests: [],
        errores: [],
        exito: false,
        resumen: {
            totalTests: 0,
            exitosos: 0,
            fallidos: 0
        }
    };

    try {
        console.log('üìã TEST 1: Verificar pol√≠ticas INSERT actuales...');
        
        // Test 1: Verificar pol√≠ticas actuales
        const { data: politicas, error: errorPoliticas } = await supabase
            .rpc('exec_sql', {
                sql: `
                SELECT 
                    policyname,
                    cmd,
                    with_check
                FROM pg_policies 
                WHERE tablename = 'users' 
                AND schemaname = 'public'
                AND cmd = 'INSERT'
                ORDER BY policyname;
                `
            });

        reporte.totalTests++;
        
        if (errorPoliticas) {
            console.log('‚ùå Error consultando pol√≠ticas:', errorPoliticas.message);
            reporte.tests.push({
                test: 1,
                nombre: 'Verificar pol√≠ticas INSERT',
                resultado: 'fallido',
                error: errorPoliticas.message
            });
            reporte.fallidos++;
        } else {
            console.log('‚úÖ Pol√≠ticas INSERT encontradas:', politicas?.length || 0);
            if (politicas && politicas.length > 0) {
                politicas.forEach(politica => {
                    console.log(`   - ${politica.policyname}: ${politica.with_check}`);
                });
            }
            
            reporte.tests.push({
                test: 1,
                nombre: 'Verificar pol√≠ticas INSERT',
                resultado: 'exitoso',
                detalles: `${politicas?.length || 0} pol√≠ticas encontradas`,
                politicas: politicas
            });
            reporte.exitosos++;
        }

        console.log('\nüß™ TEST 2: Intentar registro de usuario de prueba...');
        
        // Test 2: Intentar insertar usuario de prueba
        const usuarioPrueba = {
            id: `test-post-correccion-${Date.now()}`,
            name: 'Usuario Test Post-Correcci√≥n',
            email: `test-post-correccion-${Date.now()}@test.com`,
            phone: '+1234567890',
            password: 'password123',
            user_type: 'inquilino'
        };

        reporte.totalTests++;
        
        const { data: insertData, error: insertError } = await supabase
            .from('users')
            .insert([usuarioPrueba])
            .select();

        if (insertError) {
            console.log('‚ùå Error en inserci√≥n:', insertError.message);
            console.log('   C√≥digo:', insertError.code);
            console.log('   Detalles:', insertError.details);
            
            // Verificar si es el error espec√≠fico que estamos solucionando
            if (insertError.message.includes('Database error saving new user') || 
                insertError.message.includes('new row violates row-level security policy')) {
                console.log('üö® EL ERROR ORIGINAL PERSISTE - CORRECCI√ìN NO EXITOSA');
                reporte.tests.push({
                    test: 2,
                    nombre: 'Inserci√≥n usuario de prueba',
                    resultado: 'fallido',
                    error: insertError.message,
                    tipo: 'error_original_persiste'
                });
            } else {
                console.log('‚ö†Ô∏è Error diferente al original - puede ser esperado');
                reporte.tests.push({
                    test: 2,
                    nombre: 'Inserci√≥n usuario de prueba',
                    resultado: 'fallido',
                    error: insertError.message,
                    tipo: 'error_diferente'
                });
            }
            reporte.fallidos++;
        } else {
            console.log('‚úÖ Inserci√≥n exitosa - PROBLEMA RESUELTO');
            console.log('   Usuario creado:', insertData[0]?.id);
            
            reporte.tests.push({
                test: 2,
                nombre: 'Inserci√≥n usuario de prueba',
                resultado: 'exitoso',
                detalles: 'Usuario insertado correctamente',
                usuario_id: insertData[0]?.id
            });
            reporte.exitosos++;

            // Limpiar usuario de prueba
            console.log('\nüßπ Limpiando usuario de prueba...');
            const { error: deleteError } = await supabase
                .from('users')
                .delete()
                .eq('id', usuarioPrueba.id);

            if (deleteError) {
                console.log('‚ö†Ô∏è Error limpiando usuario de prueba:', deleteError.message);
            } else {
                console.log('‚úÖ Usuario de prueba eliminado');
            }
        }

        console.log('\nüîç TEST 3: Verificar permisos de tabla...');
        
        // Test 3: Verificar permisos
        const { data: permisos, error: errorPermisos } = await supabase
            .rpc('exec_sql', {
                sql: `
                SELECT 
                    grantee,
                    privilege_type
                FROM information_schema.table_privileges 
                WHERE table_name = 'users' 
                AND table_schema = 'public'
                AND privilege_type = 'INSERT'
                ORDER BY grantee;
                `
            });

        reporte.totalTests++;
        
        if (errorPermisos) {
            console.log('‚ùå Error consultando permisos:', errorPermisos.message);
            reporte.tests.push({
                test: 3,
                nombre: 'Verificar permisos INSERT',
                resultado: 'fallido',
                error: errorPermisos.message
            });
            reporte.fallidos++;
        } else {
            console.log('‚úÖ Permisos INSERT encontrados:', permisos?.length || 0);
            if (permisos && permisos.length > 0) {
                permisos.forEach(permiso => {
                    console.log(`   - ${permiso.grantee}: ${permiso.privilege_type}`);
                });
            }
            
            reporte.tests.push({
                test: 3,
                nombre: 'Verificar permisos INSERT',
                resultado: 'exitoso',
                detalles: `${permisos?.length || 0} permisos encontrados`,
                permisos: permisos
            });
            reporte.exitosos++;
        }

        console.log('\nüß™ TEST 4: Simular registro desde aplicaci√≥n...');
        
        // Test 4: Simular el flujo completo de registro
        const usuarioReal = {
            id: `real-user-test-${Date.now()}`,
            name: 'Juan P√©rez',
            email: `juan.perez.${Date.now()}@gmail.com`,
            phone: '+5493764123456',
            password: 'MiPassword123!',
            user_type: 'inquilino'
        };

        reporte.totalTests++;
        
        const { data: realInsertData, error: realInsertError } = await supabase
            .from('users')
            .insert([usuarioReal])
            .select();

        if (realInsertError) {
            console.log('‚ùå Error en registro real:', realInsertError.message);
            
            if (realInsertError.message.includes('Database error saving new user')) {
                console.log('üö® ERROR CR√çTICO: El problema original NO est√° resuelto');
                reporte.tests.push({
                    test: 4,
                    nombre: 'Simulaci√≥n registro real',
                    resultado: 'fallido_critico',
                    error: realInsertError.message,
                    tipo: 'problema_no_resuelto'
                });
            } else {
                console.log('‚ö†Ô∏è Error diferente - puede requerir investigaci√≥n adicional');
                reporte.tests.push({
                    test: 4,
                    nombre: 'Simulaci√≥n registro real',
                    resultado: 'fallido',
                    error: realInsertError.message,
                    tipo: 'error_adicional'
                });
            }
            reporte.fallidos++;
        } else {
            console.log('‚úÖ Registro real exitoso - PROBLEMA COMPLETAMENTE RESUELTO');
            console.log('   Usuario registrado:', realInsertData[0]?.email);
            
            reporte.tests.push({
                test: 4,
                nombre: 'Simulaci√≥n registro real',
                resultado: 'exitoso',
                detalles: 'Registro completado exitosamente',
                usuario_email: realInsertData[0]?.email
            });
            reporte.exitosos++;

            // Limpiar usuario real de prueba
            console.log('\nüßπ Limpiando usuario real de prueba...');
            const { error: realDeleteError } = await supabase
                .from('users')
                .delete()
                .eq('id', usuarioReal.id);

            if (realDeleteError) {
                console.log('‚ö†Ô∏è Error limpiando usuario real:', realDeleteError.message);
            } else {
                console.log('‚úÖ Usuario real de prueba eliminado');
            }
        }

        // Calcular resultado final
        reporte.resumen.totalTests = reporte.totalTests;
        reporte.resumen.exitosos = reporte.exitosos;
        reporte.resumen.fallidos = reporte.fallidos;
        reporte.exito = reporte.exitosos > reporte.fallidos && reporte.exitosos >= 2;

        console.log('\nüéØ RESUMEN DEL TESTING:');
        console.log('============================================================');
        console.log(`üìä Total de tests: ${reporte.resumen.totalTests}`);
        console.log(`‚úÖ Tests exitosos: ${reporte.resumen.exitosos}`);
        console.log(`‚ùå Tests fallidos: ${reporte.resumen.fallidos}`);
        console.log(`üéØ Estado final: ${reporte.exito ? 'EXITOSO' : 'REQUIERE ATENCI√ìN'}`);
        
        if (reporte.exito) {
            console.log('\nüéâ CORRECCI√ìN VERIFICADA EXITOSAMENTE');
            console.log('El error "Database error saving new user" ha sido resuelto.');
            console.log('El registro de usuarios funciona correctamente.');
        } else {
            console.log('\n‚ö†Ô∏è CORRECCI√ìN REQUIERE ATENCI√ìN ADICIONAL');
            console.log('Algunos tests fallaron. Revisar detalles en el reporte.');
        }

    } catch (error) {
        console.log('‚ùå Error cr√≠tico en testing:', error.message);
        reporte.errores.push(`Error cr√≠tico: ${error.message}`);
        reporte.exito = false;
    }

    // Guardar reporte
    try {
        fs.writeFileSync(
            'Blackbox/229-Reporte-Testing-Post-Correccion-Policy-INSERT-Users-Final.json',
            JSON.stringify(reporte, null, 2)
        );
        console.log('\nüìÑ Reporte guardado en: Blackbox/229-Reporte-Testing-Post-Correccion-Policy-INSERT-Users-Final.json');
    } catch (errorArchivo) {
        console.log('‚ùå Error guardando reporte:', errorArchivo.message);
    }

    console.log('\nüîÑ PR√ìXIMOS PASOS:');
    if (reporte.exito) {
        console.log('1. ‚úÖ Problema resuelto - Continuar con desarrollo normal');
        console.log('2. üß™ Probar registro desde la aplicaci√≥n web');
        console.log('3. üìä Monitorear registros en producci√≥n');
    } else {
        console.log('1. üîç Revisar errores espec√≠ficos en el reporte');
        console.log('2. üõ†Ô∏è Aplicar correcciones adicionales si es necesario');
        console.log('3. üîÑ Re-ejecutar testing despu√©s de correcciones');
    }

    return reporte;
}

// Ejecutar testing
testingPostCorreccion()
    .then(reporte => {
        console.log('\n‚úÖ TESTING POST-CORRECCI√ìN COMPLETADO');
        process.exit(reporte.exito ? 0 : 1);
    })
    .catch(error => {
        console.log('‚ùå Error fatal en testing:', error.message);
        process.exit(1);
    });
