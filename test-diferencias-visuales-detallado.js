const puppeteer = require('puppeteer');

console.log('üîç AN√ÅLISIS DETALLADO DE DIFERENCIAS VISUALES');
console.log('='.repeat(80));
console.log('üìç Comparando im√°genes y elementos visuales espec√≠ficos');
console.log('üåê Localhost vs Producci√≥n');
console.log('='.repeat(80));

async function analizarDiferenciasVisuales() {
  let browser;
  
  try {
    console.log('üöÄ Lanzando navegador...');
    browser = await puppeteer.launch({ 
      headless: false,
      defaultViewport: { width: 1200, height: 800 },
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    
    const page = await browser.newPage();
    
    const resultados = {
      localhost: {
        imagenes: [],
        estilos: {},
        elementos: {},
        errores: []
      },
      produccion: {
        imagenes: [],
        estilos: {},
        elementos: {},
        errores: []
      }
    };
    
    console.log('\nüìç FASE 1: AN√ÅLISIS DETALLADO LOCALHOST');
    console.log('-'.repeat(60));
    
    try {
      await page.goto('http://localhost:3000', { waitUntil: 'networkidle2', timeout: 15000 });
      console.log('‚úÖ Localhost cargado');
      
      // Analizar im√°genes en localhost
      const imagenesLocalhost = await page.evaluate(() => {
        const imgs = Array.from(document.querySelectorAll('img'));
        return imgs.map(img => ({
          src: img.src,
          alt: img.alt,
          width: img.width,
          height: img.height,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
          complete: img.complete,
          className: img.className,
          style: img.getAttribute('style') || ''
        }));
      });
      
      console.log(`üñºÔ∏è Localhost - Im√°genes encontradas: ${imagenesLocalhost.length}`);
      imagenesLocalhost.forEach((img, index) => {
        console.log(`   ${index + 1}. ${img.src}`);
        console.log(`      Alt: "${img.alt}"`);
        console.log(`      Dimensiones: ${img.width}x${img.height}`);
        console.log(`      Cargada: ${img.complete ? '‚úÖ' : '‚ùå'}`);
        console.log(`      Clase: ${img.className}`);
      });
      
      resultados.localhost.imagenes = imagenesLocalhost;
      
      // Analizar elementos espec√≠ficos del hero
      const heroLocalhost = await page.evaluate(() => {
        const hero = document.querySelector('.hero, [class*="hero"], .banner, [class*="banner"]');
        if (hero) {
          return {
            existe: true,
            className: hero.className,
            innerHTML: hero.innerHTML.substring(0, 200) + '...',
            backgroundImage: getComputedStyle(hero).backgroundImage,
            backgroundSize: getComputedStyle(hero).backgroundSize,
            backgroundPosition: getComputedStyle(hero).backgroundPosition
          };
        }
        return { existe: false };
      });
      
      console.log(`üéØ Localhost - Secci√≥n Hero: ${heroLocalhost.existe ? '‚úÖ Encontrada' : '‚ùå No encontrada'}`);
      if (heroLocalhost.existe) {
        console.log(`   Clase: ${heroLocalhost.className}`);
        console.log(`   Background: ${heroLocalhost.backgroundImage}`);
      }
      
      resultados.localhost.elementos.hero = heroLocalhost;
      
      // Analizar propiedades
      const propiedadesLocalhost = await page.evaluate(() => {
        const propCards = Array.from(document.querySelectorAll('.property-card, [class*="property"], .card, [class*="card"]'));
        return propCards.slice(0, 3).map(card => {
          const img = card.querySelector('img');
          return {
            existe: true,
            className: card.className,
            imagen: img ? {
              src: img.src,
              alt: img.alt,
              complete: img.complete
            } : null
          };
        });
      });
      
      console.log(`üè† Localhost - Tarjetas de propiedades: ${propiedadesLocalhost.length}`);
      propiedadesLocalhost.forEach((prop, index) => {
        if (prop.imagen) {
          console.log(`   ${index + 1}. Imagen: ${prop.imagen.src}`);
          console.log(`      Cargada: ${prop.imagen.complete ? '‚úÖ' : '‚ùå'}`);
        }
      });
      
      resultados.localhost.elementos.propiedades = propiedadesLocalhost;
      
    } catch (error) {
      console.log(`‚ùå Error en localhost: ${error.message}`);
      resultados.localhost.errores.push(error.message);
    }
    
    console.log('\nüåê FASE 2: AN√ÅLISIS DETALLADO PRODUCCI√ìN');
    console.log('-'.repeat(60));
    
    try {
      await page.goto('https://www.misionesarrienda.com.ar', { waitUntil: 'networkidle2', timeout: 15000 });
      console.log('‚úÖ Producci√≥n cargada');
      
      // Analizar im√°genes en producci√≥n
      const imagenesProduccion = await page.evaluate(() => {
        const imgs = Array.from(document.querySelectorAll('img'));
        return imgs.map(img => ({
          src: img.src,
          alt: img.alt,
          width: img.width,
          height: img.height,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
          complete: img.complete,
          className: img.className,
          style: img.getAttribute('style') || ''
        }));
      });
      
      console.log(`üñºÔ∏è Producci√≥n - Im√°genes encontradas: ${imagenesProduccion.length}`);
      imagenesProduccion.forEach((img, index) => {
        console.log(`   ${index + 1}. ${img.src}`);
        console.log(`      Alt: "${img.alt}"`);
        console.log(`      Dimensiones: ${img.width}x${img.height}`);
        console.log(`      Cargada: ${img.complete ? '‚úÖ' : '‚ùå'}`);
        console.log(`      Clase: ${img.className}`);
      });
      
      resultados.produccion.imagenes = imagenesProduccion;
      
      // Analizar elementos espec√≠ficos del hero
      const heroProduccion = await page.evaluate(() => {
        const hero = document.querySelector('.hero, [class*="hero"], .banner, [class*="banner"]');
        if (hero) {
          return {
            existe: true,
            className: hero.className,
            innerHTML: hero.innerHTML.substring(0, 200) + '...',
            backgroundImage: getComputedStyle(hero).backgroundImage,
            backgroundSize: getComputedStyle(hero).backgroundSize,
            backgroundPosition: getComputedStyle(hero).backgroundPosition
          };
        }
        return { existe: false };
      });
      
      console.log(`üéØ Producci√≥n - Secci√≥n Hero: ${heroProduccion.existe ? '‚úÖ Encontrada' : '‚ùå No encontrada'}`);
      if (heroProduccion.existe) {
        console.log(`   Clase: ${heroProduccion.className}`);
        console.log(`   Background: ${heroProduccion.backgroundImage}`);
      }
      
      resultados.produccion.elementos.hero = heroProduccion;
      
      // Analizar propiedades
      const propiedadesProduccion = await page.evaluate(() => {
        const propCards = Array.from(document.querySelectorAll('.property-card, [class*="property"], .card, [class*="card"]'));
        return propCards.slice(0, 3).map(card => {
          const img = card.querySelector('img');
          return {
            existe: true,
            className: card.className,
            imagen: img ? {
              src: img.src,
              alt: img.alt,
              complete: img.complete
            } : null
          };
        });
      });
      
      console.log(`üè† Producci√≥n - Tarjetas de propiedades: ${propiedadesProduccion.length}`);
      propiedadesProduccion.forEach((prop, index) => {
        if (prop.imagen) {
          console.log(`   ${index + 1}. Imagen: ${prop.imagen.src}`);
          console.log(`      Cargada: ${prop.imagen.complete ? '‚úÖ' : '‚ùå'}`);
        }
      });
      
      resultados.produccion.elementos.propiedades = propiedadesProduccion;
      
    } catch (error) {
      console.log(`‚ùå Error en producci√≥n: ${error.message}`);
      resultados.produccion.errores.push(error.message);
    }
    
    console.log('\nüìä FASE 3: COMPARACI√ìN DETALLADA DE DIFERENCIAS');
    console.log('-'.repeat(60));
    
    // Comparar cantidad de im√°genes
    console.log('üñºÔ∏è COMPARACI√ìN DE IM√ÅGENES:');
    console.log(`   Localhost: ${resultados.localhost.imagenes.length} im√°genes`);
    console.log(`   Producci√≥n: ${resultados.produccion.imagenes.length} im√°genes`);
    
    if (resultados.localhost.imagenes.length !== resultados.produccion.imagenes.length) {
      console.log('   ‚ö†Ô∏è DIFERENCIA: Cantidad de im√°genes diferente');
    }
    
    // Comparar URLs de im√°genes
    console.log('\nüîó COMPARACI√ìN DE URLs DE IM√ÅGENES:');
    const urlsLocalhost = resultados.localhost.imagenes.map(img => img.src);
    const urlsProduccion = resultados.produccion.imagenes.map(img => img.src);
    
    const diferenciasUrls = [];
    
    // Verificar im√°genes que est√°n en localhost pero no en producci√≥n
    urlsLocalhost.forEach((url, index) => {
      const urlBase = url.replace('http://localhost:3000', '').replace('https://www.misionesarrienda.com.ar', '');
      const existeEnProduccion = urlsProduccion.some(prodUrl => 
        prodUrl.replace('https://www.misionesarrienda.com.ar', '') === urlBase
      );
      
      if (!existeEnProduccion) {
        diferenciasUrls.push({
          tipo: 'Solo en localhost',
          url: url,
          index: index
        });
      }
    });
    
    // Verificar im√°genes que est√°n en producci√≥n pero no en localhost
    urlsProduccion.forEach((url, index) => {
      const urlBase = url.replace('https://www.misionesarrienda.com.ar', '').replace('http://localhost:3000', '');
      const existeEnLocalhost = urlsLocalhost.some(localUrl => 
        localUrl.replace('http://localhost:3000', '') === urlBase
      );
      
      if (!existeEnLocalhost) {
        diferenciasUrls.push({
          tipo: 'Solo en producci√≥n',
          url: url,
          index: index
        });
      }
    });
    
    if (diferenciasUrls.length > 0) {
      console.log('   ‚ö†Ô∏è DIFERENCIAS ENCONTRADAS:');
      diferenciasUrls.forEach(diff => {
        console.log(`   ${diff.tipo}: ${diff.url}`);
      });
    } else {
      console.log('   ‚úÖ URLs de im√°genes coinciden');
    }
    
    // Comparar estado de carga de im√°genes
    console.log('\nüì• COMPARACI√ìN DE CARGA DE IM√ÅGENES:');
    const imagenesRotasLocalhost = resultados.localhost.imagenes.filter(img => !img.complete);
    const imagenesRotasProduccion = resultados.produccion.imagenes.filter(img => !img.complete);
    
    console.log(`   Localhost - Im√°genes no cargadas: ${imagenesRotasLocalhost.length}`);
    imagenesRotasLocalhost.forEach(img => {
      console.log(`     ‚ùå ${img.src}`);
    });
    
    console.log(`   Producci√≥n - Im√°genes no cargadas: ${imagenesRotasProduccion.length}`);
    imagenesRotasProduccion.forEach(img => {
      console.log(`     ‚ùå ${img.src}`);
    });
    
    console.log('\nüéØ FASE 4: DIAGN√ìSTICO DE PROBLEMAS');
    console.log('-'.repeat(60));
    
    if (diferenciasUrls.length > 0 || imagenesRotasLocalhost.length > 0 || imagenesRotasProduccion.length > 0) {
      console.log('‚ùå PROBLEMAS DETECTADOS:');
      
      if (diferenciasUrls.length > 0) {
        console.log('   üî∏ Im√°genes diferentes entre entornos');
      }
      
      if (imagenesRotasLocalhost.length > 0) {
        console.log('   üî∏ Im√°genes rotas en localhost');
      }
      
      if (imagenesRotasProduccion.length > 0) {
        console.log('   üî∏ Im√°genes rotas en producci√≥n');
      }
      
      console.log('\nüí° POSIBLES CAUSAS:');
      console.log('   ‚Ä¢ Cache del navegador desactualizado en localhost');
      console.log('   ‚Ä¢ Archivos de imagen no sincronizados');
      console.log('   ‚Ä¢ Diferencias en el build de desarrollo vs producci√≥n');
      console.log('   ‚Ä¢ Problemas de rutas de im√°genes');
      
      console.log('\nüîß RECOMENDACIONES:');
      console.log('   1. Limpiar cache del navegador');
      console.log('   2. Reiniciar servidor de desarrollo');
      console.log('   3. Verificar que las im√°genes est√©n en public/');
      console.log('   4. Comparar archivos de imagen entre entornos');
      
    } else {
      console.log('‚úÖ No se detectaron problemas significativos');
    }
    
    console.log('\n‚úÖ AN√ÅLISIS COMPLETADO');
    
  } catch (error) {
    console.error('‚ùå Error durante el an√°lisis:', error);
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

// Ejecutar an√°lisis
analizarDiferenciasVisuales().then(() => {
  console.log('\nüèÅ An√°lisis de diferencias visuales finalizado');
}).catch(error => {
  console.error('üí• Error fatal:', error);
});
