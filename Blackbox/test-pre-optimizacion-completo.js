const { createClient } = require('@supabase/supabase-js');

console.log('üß™ TEST PRE-OPTIMIZACI√ìN COMPLETO');
console.log('=' .repeat(70));

const SUPABASE_URL = 'https://qfeyhaaxyemmnohqdele.supabase.co';
const SUPABASE_SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmZXloYWF4eWVtbW5vaHFkZWxlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTgxNjczOCwiZXhwIjoyMDcxMzkyNzM4fQ.5wJb1p0Rmg1dVIayIT4wZO_seDXTIwhVa36CyEgK-yM';

async function testPreOptimizacion() {
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    
    console.log('üìÖ Fecha:', new Date().toISOString());
    console.log('üéØ Objetivo: Verificar estado actual ANTES de optimizaci√≥n');
    console.log('');

    const resultados = {
        tests: [],
        errores: [],
        warnings: [],
        estadoGeneral: 'DESCONOCIDO'
    };

    let testsExitosos = 0;
    let totalTests = 0;

    try {
        // =====================================================
        // TEST 1: CONEXI√ìN B√ÅSICA
        // =====================================================
        totalTests++;
        console.log('üîó TEST 1: CONEXI√ìN B√ÅSICA...');
        console.log('-'.repeat(40));

        try {
            const { data: connectionTest, error: connectionError } = await supabase
                .from('users')
                .select('count')
                .limit(1);

            if (connectionError) {
                console.log('   ‚ùå FALLO: Error de conexi√≥n');
                console.log(`      ‚îî‚îÄ ${connectionError.message}`);
                resultados.errores.push({
                    test: 'conexion',
                    error: connectionError.message
                });
            } else {
                console.log('   ‚úÖ √âXITO: Conexi√≥n establecida');
                testsExitosos++;
                resultados.tests.push({
                    test: 'conexion',
                    resultado: 'exitoso'
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n en conexi√≥n');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'conexion',
                error: error.message
            });
        }

        // =====================================================
        // TEST 2: USUARIO CR√çTICO (ERROR 406)
        // =====================================================
        totalTests++;
        console.log('');
        console.log('üë§ TEST 2: USUARIO CR√çTICO (ERROR 406)...');
        console.log('-'.repeat(40));

        try {
            const { data: usuarioCritico, error: usuarioError } = await supabase
                .from('users')
                .select('id, user_type, created_at, name, email')
                .eq('id', '6403f9d2-e846-4c70-87e0-e051127d9500')
                .single();

            if (usuarioError) {
                console.log('   ‚ùå FALLO: Usuario cr√≠tico no accesible');
                console.log(`      ‚îî‚îÄ ${usuarioError.message}`);
                console.log('      üö® CR√çTICO: Error 406 puede estar presente');
                resultados.errores.push({
                    test: 'usuario_critico',
                    error: usuarioError.message,
                    criticidad: 'ALTA'
                });
            } else if (usuarioCritico) {
                console.log('   ‚úÖ √âXITO: Usuario cr√≠tico accesible');
                console.log(`      ‚îî‚îÄ ID: ${usuarioCritico.id}`);
                console.log(`      ‚îî‚îÄ Tipo: ${usuarioCritico.user_type}`);
                console.log(`      ‚îî‚îÄ Email: ${usuarioCritico.email}`);
                testsExitosos++;
                resultados.tests.push({
                    test: 'usuario_critico',
                    resultado: 'exitoso',
                    datos: usuarioCritico
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n en usuario cr√≠tico');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'usuario_critico',
                error: error.message,
                criticidad: 'ALTA'
            });
        }

        // =====================================================
        // TEST 3: RLS HABILITADO
        // =====================================================
        totalTests++;
        console.log('');
        console.log('üîí TEST 3: RLS HABILITADO...');
        console.log('-'.repeat(40));

        try {
            const { data: rlsStatus, error: rlsError } = await supabase
                .from('pg_tables')
                .select('schemaname, tablename, rowsecurity')
                .eq('schemaname', 'public')
                .eq('tablename', 'users')
                .single();

            if (rlsError) {
                console.log('   ‚ùå FALLO: No se puede verificar RLS');
                console.log(`      ‚îî‚îÄ ${rlsError.message}`);
                resultados.errores.push({
                    test: 'rls_status',
                    error: rlsError.message
                });
            } else if (rlsStatus && rlsStatus.rowsecurity) {
                console.log('   ‚úÖ √âXITO: RLS habilitado correctamente');
                testsExitosos++;
                resultados.tests.push({
                    test: 'rls_status',
                    resultado: 'exitoso',
                    rls_habilitado: true
                });
            } else {
                console.log('   ‚ö†Ô∏è ADVERTENCIA: RLS no habilitado');
                resultados.warnings.push({
                    test: 'rls_status',
                    mensaje: 'RLS no est√° habilitado en tabla users'
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n verificando RLS');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'rls_status',
                error: error.message
            });
        }

        // =====================================================
        // TEST 4: POL√çTICAS ACTUALES
        // =====================================================
        totalTests++;
        console.log('');
        console.log('üõ°Ô∏è TEST 4: POL√çTICAS ACTUALES...');
        console.log('-'.repeat(40));

        try {
            const { data: politicas, error: politicasError } = await supabase
                .from('pg_policies')
                .select('policyname, cmd, roles')
                .eq('schemaname', 'public')
                .eq('tablename', 'users');

            if (politicasError) {
                console.log('   ‚ùå FALLO: No se pueden obtener pol√≠ticas');
                console.log(`      ‚îî‚îÄ ${politicasError.message}`);
                resultados.errores.push({
                    test: 'politicas',
                    error: politicasError.message
                });
            } else if (politicas && politicas.length > 0) {
                console.log(`   ‚úÖ √âXITO: ${politicas.length} pol√≠ticas encontradas`);
                politicas.forEach(p => {
                    console.log(`      ‚îî‚îÄ ${p.policyname} (${p.cmd})`);
                });
                testsExitosos++;
                resultados.tests.push({
                    test: 'politicas',
                    resultado: 'exitoso',
                    total_politicas: politicas.length,
                    politicas: politicas
                });
            } else {
                console.log('   ‚ö†Ô∏è ADVERTENCIA: No se encontraron pol√≠ticas');
                resultados.warnings.push({
                    test: 'politicas',
                    mensaje: 'No hay pol√≠ticas RLS configuradas'
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n obteniendo pol√≠ticas');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'politicas',
                error: error.message
            });
        }

        // =====================================================
        // TEST 5: OPERACIONES CRUD B√ÅSICAS
        // =====================================================
        totalTests++;
        console.log('');
        console.log('üìù TEST 5: OPERACIONES CRUD B√ÅSICAS...');
        console.log('-'.repeat(40));

        try {
            // Test SELECT
            const { data: selectTest, error: selectError } = await supabase
                .from('users')
                .select('id, user_type')
                .limit(3);

            if (selectError) {
                console.log('   ‚ùå FALLO: SELECT no funciona');
                console.log(`      ‚îî‚îÄ ${selectError.message}`);
                resultados.errores.push({
                    test: 'crud_select',
                    error: selectError.message
                });
            } else {
                console.log(`   ‚úÖ √âXITO: SELECT funciona (${selectTest?.length || 0} registros)`);
                testsExitosos++;
                resultados.tests.push({
                    test: 'crud_select',
                    resultado: 'exitoso',
                    registros_obtenidos: selectTest?.length || 0
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n en operaciones CRUD');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'crud_select',
                error: error.message
            });
        }

        // =====================================================
        // TEST 6: √çNDICES DE EMAIL
        // =====================================================
        totalTests++;
        console.log('');
        console.log('üìä TEST 6: √çNDICES DE EMAIL...');
        console.log('-'.repeat(40));

        try {
            const { data: indices, error: indicesError } = await supabase
                .from('pg_indexes')
                .select('indexname, tablename')
                .eq('schemaname', 'public')
                .eq('tablename', 'users')
                .like('indexname', '%email%');

            if (indicesError) {
                console.log('   ‚ùå FALLO: No se pueden obtener √≠ndices');
                console.log(`      ‚îî‚îÄ ${indicesError.message}`);
                resultados.errores.push({
                    test: 'indices_email',
                    error: indicesError.message
                });
            } else if (indices) {
                console.log(`   ‚úÖ √âXITO: ${indices.length} √≠ndices de email encontrados`);
                indices.forEach(idx => {
                    console.log(`      ‚îî‚îÄ ${idx.indexname}`);
                });
                
                if (indices.length > 1) {
                    console.log('   ‚ö†Ô∏è ADVERTENCIA: M√∫ltiples √≠ndices detectados (Duplicate Index warning)');
                    resultados.warnings.push({
                        test: 'indices_email',
                        mensaje: `${indices.length} √≠ndices de email (posible duplicaci√≥n)`
                    });
                }
                
                testsExitosos++;
                resultados.tests.push({
                    test: 'indices_email',
                    resultado: 'exitoso',
                    total_indices: indices.length,
                    indices: indices
                });
            }
        } catch (error) {
            console.log('   ‚ùå FALLO: Excepci√≥n obteniendo √≠ndices');
            console.log(`      ‚îî‚îÄ ${error.message}`);
            resultados.errores.push({
                test: 'indices_email',
                error: error.message
            });
        }

        // =====================================================
        // RESUMEN DE RESULTADOS
        // =====================================================
        console.log('');
        console.log('üìä RESUMEN DE TESTS PRE-OPTIMIZACI√ìN');
        console.log('='.repeat(70));

        const porcentajeExito = Math.round((testsExitosos / totalTests) * 100);
        
        console.log(`üìà ESTAD√çSTICAS:`);
        console.log(`   Tests ejecutados: ${totalTests}`);
        console.log(`   Tests exitosos: ${testsExitosos}`);
        console.log(`   Tests fallidos: ${totalTests - testsExitosos}`);
        console.log(`   Porcentaje de √©xito: ${porcentajeExito}%`);
        console.log(`   Errores cr√≠ticos: ${resultados.errores.filter(e => e.criticidad === 'ALTA').length}`);
        console.log(`   Advertencias: ${resultados.warnings.length}`);

        // Determinar estado general
        if (porcentajeExito >= 90 && resultados.errores.filter(e => e.criticidad === 'ALTA').length === 0) {
            resultados.estadoGeneral = 'EXCELENTE';
            console.log('');
            console.log('‚úÖ ESTADO GENERAL: EXCELENTE');
            console.log('üöÄ RECOMENDACI√ìN: PROCEDER con optimizaci√≥n');
            console.log('üõ°Ô∏è RIESGO: M√çNIMO');
        } else if (porcentajeExito >= 70 && resultados.errores.filter(e => e.criticidad === 'ALTA').length === 0) {
            resultados.estadoGeneral = 'BUENO';
            console.log('');
            console.log('‚úÖ ESTADO GENERAL: BUENO');
            console.log('‚ö†Ô∏è RECOMENDACI√ìN: PROCEDER con precauci√≥n');
            console.log('üõ°Ô∏è RIESGO: BAJO');
        } else if (resultados.errores.filter(e => e.criticidad === 'ALTA').length > 0) {
            resultados.estadoGeneral = 'CR√çTICO';
            console.log('');
            console.log('‚ùå ESTADO GENERAL: CR√çTICO');
            console.log('üö® RECOMENDACI√ìN: NO PROCEDER - Resolver errores cr√≠ticos primero');
            console.log('üõ°Ô∏è RIESGO: ALTO');
        } else {
            resultados.estadoGeneral = 'REGULAR';
            console.log('');
            console.log('‚ö†Ô∏è ESTADO GENERAL: REGULAR');
            console.log('üîç RECOMENDACI√ìN: INVESTIGAR errores antes de proceder');
            console.log('üõ°Ô∏è RIESGO: MEDIO');
        }

        // Crear backup de estado actual
        const fs = require('fs');
        const backupEstado = {
            timestamp: new Date().toISOString(),
            tests_pre_optimizacion: resultados,
            porcentaje_exito: porcentajeExito,
            estado_general: resultados.estadoGeneral
        };

        fs.writeFileSync(
            'Blackbox/backup-estado-pre-optimizacion.json',
            JSON.stringify(backupEstado, null, 2)
        );

        console.log('');
        console.log('üíæ BACKUP CREADO: backup-estado-pre-optimizacion.json');
        console.log('');
        console.log('üéØ PR√ìXIMOS PASOS:');
        
        if (resultados.estadoGeneral === 'EXCELENTE' || resultados.estadoGeneral === 'BUENO') {
            console.log('1. ‚úÖ Estado actual verificado y estable');
            console.log('2. üöÄ Proceder con optimizaci√≥n gradual');
            console.log('3. üß™ Ejecutar tests post-optimizaci√≥n');
            console.log('4. üìä Verificar warnings eliminados');
        } else {
            console.log('1. üîç Resolver errores identificados');
            console.log('2. üß™ Re-ejecutar tests pre-optimizaci√≥n');
            console.log('3. ‚úÖ Confirmar estado estable');
            console.log('4. üöÄ Proceder con optimizaci√≥n');
        }

        console.log('');
        console.log('‚úÖ TEST PRE-OPTIMIZACI√ìN COMPLETADO');

        return resultados;

    } catch (error) {
        console.error('‚ùå Error cr√≠tico en tests pre-optimizaci√≥n:', error.message);
        resultados.errores.push({
            test: 'general',
            error: error.message,
            criticidad: 'CR√çTICA'
        });
        resultados.estadoGeneral = 'ERROR';
        return resultados;
    }
}

// Ejecutar tests
if (require.main === module) {
    testPreOptimizacion().catch(console.error);
}

module.exports = { testPreOptimizacion };
