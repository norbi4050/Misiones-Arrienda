/**
 * TESTING EXHAUSTIVO COMPLETO POST-CORRECCI√ìN SUPABASE
 * Verifica todas las funcionalidades de la plataforma Misiones Arrienda
 */

const fs = require('fs');
const path = require('path');

// Configuraci√≥n de testing
const BASE_URL = 'http://localhost:3000';
const TIMEOUT = 10000;

// Resultados del testing
let testResults = {
    total: 0,
    passed: 0,
    failed: 0,
    errors: [],
    details: []
};

// Funci√≥n para simular requests HTTP
async function testEndpoint(url, method = 'GET', data = null) {
    try {
        const fetch = (await import('node-fetch')).default;
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'Testing-Bot/1.0'
            },
            timeout: TIMEOUT
        };
        
        if (data && method !== 'GET') {
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(url, options);
        return {
            status: response.status,
            ok: response.ok,
            headers: response.headers,
            url: response.url
        };
    } catch (error) {
        return {
            status: 0,
            ok: false,
            error: error.message
        };
    }
}

// Funci√≥n para verificar archivos
function checkFile(filePath) {
    try {
        return fs.existsSync(filePath);
    } catch (error) {
        return false;
    }
}

// Funci√≥n para registrar resultados
function logTest(testName, passed, details = '') {
    testResults.total++;
    if (passed) {
        testResults.passed++;
        console.log(`‚úÖ ${testName}`);
    } else {
        testResults.failed++;
        testResults.errors.push(`‚ùå ${testName}: ${details}`);
        console.log(`‚ùå ${testName}: ${details}`);
    }
    
    testResults.details.push({
        test: testName,
        passed,
        details,
        timestamp: new Date().toISOString()
    });
}

// TESTING EXHAUSTIVO COMPLETO
async function runExhaustiveTesting() {
    console.log('üöÄ INICIANDO TESTING EXHAUSTIVO COMPLETO POST-CORRECCI√ìN SUPABASE');
    console.log('================================================================');
    
    // 1. VERIFICACI√ìN DE CONFIGURACI√ìN SUPABASE
    console.log('\nüìã 1. VERIFICACI√ìN CONFIGURACI√ìN SUPABASE');
    console.log('------------------------------------------');
    
    const envExists = checkFile(path.join(__dirname, '.env.local'));
    logTest('Archivo .env.local existe', envExists);
    
    if (envExists) {
        try {
            const envContent = fs.readFileSync(path.join(__dirname, '.env.local'), 'utf8');
            const hasSupabaseUrl = envContent.includes('NEXT_PUBLIC_SUPABASE_URL');
            const hasSupabaseKey = envContent.includes('NEXT_PUBLIC_SUPABASE_ANON_KEY');
            const hasServiceKey = envContent.includes('SUPABASE_SERVICE_ROLE_KEY');
            const hasDatabaseUrl = envContent.includes('DATABASE_URL');
            
            logTest('Variable NEXT_PUBLIC_SUPABASE_URL configurada', hasSupabaseUrl);
            logTest('Variable NEXT_PUBLIC_SUPABASE_ANON_KEY configurada', hasSupabaseKey);
            logTest('Variable SUPABASE_SERVICE_ROLE_KEY configurada', hasServiceKey);
            logTest('Variable DATABASE_URL configurada', hasDatabaseUrl);
            
            const allConfigured = hasSupabaseUrl && hasSupabaseKey && hasServiceKey && hasDatabaseUrl;
            logTest('Configuraci√≥n Supabase completa', allConfigured);
        } catch (error) {
            logTest('Lectura de .env.local', false, error.message);
        }
    }
    
    // 2. TESTING CR√çTICO - SISTEMA DE AUTENTICACI√ìN
    console.log('\nüîê 2. TESTING CR√çTICO - SISTEMA DE AUTENTICACI√ìN');
    console.log('------------------------------------------------');
    
    // P√°gina de registro
    const registerResponse = await testEndpoint(`${BASE_URL}/register`);
    logTest('P√°gina de registro accesible', registerResponse.ok, `Status: ${registerResponse.status}`);
    
    // P√°gina de login
    const loginResponse = await testEndpoint(`${BASE_URL}/login`);
    logTest('P√°gina de login accesible', loginResponse.ok, `Status: ${loginResponse.status}`);
    
    // API de registro
    const registerApiResponse = await testEndpoint(`${BASE_URL}/api/auth/register`, 'POST', {
        email: 'test@example.com',
        password: 'testpassword123',
        name: 'Test User'
    });
    logTest('API de registro responde', registerApiResponse.status !== 0, `Status: ${registerApiResponse.status}`);
    
    // API de login
    const loginApiResponse = await testEndpoint(`${BASE_URL}/api/auth/login`, 'POST', {
        email: 'test@example.com',
        password: 'testpassword123'
    });
    logTest('API de login responde', loginApiResponse.status !== 0, `Status: ${loginApiResponse.status}`);
    
    // 3. TESTING FUNCIONALIDADES PRINCIPALES
    console.log('\nüè† 3. TESTING FUNCIONALIDADES PRINCIPALES');
    console.log('----------------------------------------');
    
    // P√°gina principal
    const homeResponse = await testEndpoint(BASE_URL);
    logTest('P√°gina principal carga', homeResponse.ok, `Status: ${homeResponse.status}`);
    
    // P√°gina de propiedades
    const propertiesResponse = await testEndpoint(`${BASE_URL}/properties`);
    logTest('P√°gina de propiedades carga', propertiesResponse.ok, `Status: ${propertiesResponse.status}`);
    
    // API de propiedades
    const propertiesApiResponse = await testEndpoint(`${BASE_URL}/api/properties`);
    logTest('API de propiedades responde', propertiesApiResponse.status !== 0, `Status: ${propertiesApiResponse.status}`);
    
    // P√°gina de publicar
    const publicarResponse = await testEndpoint(`${BASE_URL}/publicar`);
    logTest('P√°gina de publicar accesible', publicarResponse.status !== 0, `Status: ${publicarResponse.status}`);
    
    // Dashboard
    const dashboardResponse = await testEndpoint(`${BASE_URL}/dashboard`);
    logTest('Dashboard accesible', dashboardResponse.status !== 0, `Status: ${dashboardResponse.status}`);
    
    // 4. TESTING P√ÅGINAS ESPEC√çFICAS DE CIUDADES
    console.log('\nüåÜ 4. TESTING P√ÅGINAS DE CIUDADES');
    console.log('--------------------------------');
    
    const cities = ['posadas', 'puerto-iguazu', 'obera', 'eldorado'];
    for (const city of cities) {
        const cityResponse = await testEndpoint(`${BASE_URL}/${city}`);
        logTest(`P√°gina de ${city} carga`, cityResponse.ok, `Status: ${cityResponse.status}`);
    }
    
    // 5. TESTING P√ÅGINAS LEGALES Y ADICIONALES
    console.log('\nüìÑ 5. TESTING P√ÅGINAS LEGALES');
    console.log('-----------------------------');
    
    const legalPages = ['privacy', 'terms'];
    for (const page of legalPages) {
        const pageResponse = await testEndpoint(`${BASE_URL}/${page}`);
        logTest(`P√°gina ${page} carga`, pageResponse.ok, `Status: ${pageResponse.status}`);
    }
    
    // 6. TESTING SISTEMA DE PERFILES
    console.log('\nüë§ 6. TESTING SISTEMA DE PERFILES');
    console.log('---------------------------------');
    
    const profilesResponse = await testEndpoint(`${BASE_URL}/profiles`);
    logTest('P√°gina de perfiles carga', profilesResponse.ok, `Status: ${profilesResponse.status}`);
    
    const profileApiResponse = await testEndpoint(`${BASE_URL}/api/users/profile`);
    logTest('API de perfiles responde', profileApiResponse.status !== 0, `Status: ${profileApiResponse.status}`);
    
    // 7. TESTING M√ìDULO DE COMUNIDAD
    console.log('\nüèòÔ∏è 7. TESTING M√ìDULO DE COMUNIDAD');
    console.log('----------------------------------');
    
    const comunidadResponse = await testEndpoint(`${BASE_URL}/comunidad`);
    logTest('P√°gina de comunidad carga', comunidadResponse.ok, `Status: ${comunidadResponse.status}`);
    
    const comunidadPublicarResponse = await testEndpoint(`${BASE_URL}/comunidad/publicar`);
    logTest('P√°gina comunidad/publicar carga', comunidadPublicarResponse.ok, `Status: ${comunidadPublicarResponse.status}`);
    
    // 8. TESTING SISTEMA DE PAGOS
    console.log('\nüí≥ 8. TESTING SISTEMA DE PAGOS');
    console.log('------------------------------');
    
    const paymentPages = ['payment/success', 'payment/failure', 'payment/pending'];
    for (const page of paymentPages) {
        const paymentResponse = await testEndpoint(`${BASE_URL}/${page}`);
        logTest(`P√°gina ${page} carga`, paymentResponse.ok, `Status: ${paymentResponse.status}`);
    }
    
    const paymentsApiResponse = await testEndpoint(`${BASE_URL}/api/payments/create-preference`, 'POST', {
        amount: 1000,
        description: 'Test payment'
    });
    logTest('API de pagos responde', paymentsApiResponse.status !== 0, `Status: ${paymentsApiResponse.status}`);
    
    // 9. TESTING FUNCIONALIDADES AVANZADAS
    console.log('\n‚ö° 9. TESTING FUNCIONALIDADES AVANZADAS');
    console.log('--------------------------------------');
    
    // API de favoritos
    const favoritesApiResponse = await testEndpoint(`${BASE_URL}/api/favorites`);
    logTest('API de favoritos responde', favoritesApiResponse.status !== 0, `Status: ${favoritesApiResponse.status}`);
    
    // API de historial de b√∫squeda
    const searchHistoryApiResponse = await testEndpoint(`${BASE_URL}/api/search-history`);
    logTest('API de historial responde', searchHistoryApiResponse.status !== 0, `Status: ${searchHistoryApiResponse.status}`);
    
    // API de estad√≠sticas
    const statsApiResponse = await testEndpoint(`${BASE_URL}/api/stats`);
    logTest('API de estad√≠sticas responde', statsApiResponse.status !== 0, `Status: ${statsApiResponse.status}`);
    
    // 10. TESTING ARCHIVOS EST√ÅTICOS Y RECURSOS
    console.log('\nüìÅ 10. TESTING ARCHIVOS Y RECURSOS');
    console.log('----------------------------------');
    
    // Verificar archivos cr√≠ticos
    const criticalFiles = [
        'package.json',
        'next.config.js',
        'tailwind.config.ts',
        'tsconfig.json',
        'src/app/layout.tsx',
        'src/app/page.tsx',
        'src/lib/supabase/client.ts',
        'src/lib/supabase/server.ts'
    ];
    
    for (const file of criticalFiles) {
        const fileExists = checkFile(path.join(__dirname, file));
        logTest(`Archivo ${file} existe`, fileExists);
    }
    
    // Sitemap y robots
    const sitemapResponse = await testEndpoint(`${BASE_URL}/sitemap.xml`);
    logTest('Sitemap accesible', sitemapResponse.ok, `Status: ${sitemapResponse.status}`);
    
    const robotsResponse = await testEndpoint(`${BASE_URL}/robots.txt`);
    logTest('Robots.txt accesible', robotsResponse.ok, `Status: ${robotsResponse.status}`);
    
    // GENERAR REPORTE FINAL
    console.log('\nüìä GENERANDO REPORTE FINAL...');
    console.log('=============================');
    
    const reportContent = generateFinalReport();
    
    // Guardar reporte
    const reportPath = path.join(__dirname, 'REPORTE-TESTING-EXHAUSTIVO-POST-SUPABASE-FINAL.md');
    fs.writeFileSync(reportPath, reportContent, 'utf8');
    
    console.log(`\n‚úÖ Reporte guardado en: ${reportPath}`);
    
    // Mostrar resumen
    console.log('\nüìà RESUMEN FINAL:');
    console.log(`Total de pruebas: ${testResults.total}`);
    console.log(`‚úÖ Exitosas: ${testResults.passed}`);
    console.log(`‚ùå Fallidas: ${testResults.failed}`);
    console.log(`üìä Porcentaje de √©xito: ${((testResults.passed / testResults.total) * 100).toFixed(1)}%`);
    
    if (testResults.failed > 0) {
        console.log('\n‚ùå ERRORES ENCONTRADOS:');
        testResults.errors.forEach(error => console.log(error));
    }
    
    return testResults;
}

function generateFinalReport() {
    const timestamp = new Date().toISOString();
    const successRate = ((testResults.passed / testResults.total) * 100).toFixed(1);
    
    let report = `# üöÄ REPORTE TESTING EXHAUSTIVO POST-CORRECCI√ìN SUPABASE

**Fecha:** ${timestamp}  
**Plataforma:** Misiones Arrienda  
**Tipo:** Testing Exhaustivo Completo  

## üìä RESUMEN EJECUTIVO

- **Total de pruebas:** ${testResults.total}
- **‚úÖ Exitosas:** ${testResults.passed}
- **‚ùå Fallidas:** ${testResults.failed}
- **üìà Tasa de √©xito:** ${successRate}%

## üéØ ESTADO GENERAL

`;

    if (successRate >= 90) {
        report += `‚úÖ **EXCELENTE** - La plataforma est√° funcionando correctamente\n\n`;
    } else if (successRate >= 75) {
        report += `‚ö†Ô∏è **BUENO** - La plataforma funciona con algunos problemas menores\n\n`;
    } else if (successRate >= 50) {
        report += `üö® **REGULAR** - La plataforma tiene problemas significativos\n\n`;
    } else {
        report += `‚ùå **CR√çTICO** - La plataforma tiene problemas graves\n\n`;
    }

    // Detalles por categor√≠a
    report += `## üìã RESULTADOS DETALLADOS

### ‚úÖ PRUEBAS EXITOSAS (${testResults.passed})
`;

    testResults.details.filter(test => test.passed).forEach(test => {
        report += `- ${test.test}\n`;
    });

    if (testResults.failed > 0) {
        report += `\n### ‚ùå PRUEBAS FALLIDAS (${testResults.failed})
`;
        testResults.details.filter(test => !test.passed).forEach(test => {
            report += `- ${test.test}: ${test.details}\n`;
        });
    }

    report += `\n## üîç AN√ÅLISIS ESPEC√çFICO

### üîê Sistema de Autenticaci√≥n
`;

    const authTests = testResults.details.filter(test => 
        test.test.toLowerCase().includes('registro') || 
        test.test.toLowerCase().includes('login') || 
        test.test.toLowerCase().includes('auth')
    );

    const authPassed = authTests.filter(test => test.passed).length;
    const authTotal = authTests.length;
    const authRate = authTotal > 0 ? ((authPassed / authTotal) * 100).toFixed(1) : 0;

    if (authRate >= 80) {
        report += `‚úÖ **OPERATIVO** (${authRate}%) - Sistema de autenticaci√≥n funcionando correctamente\n`;
    } else {
        report += `‚ùå **PROBLEMAS** (${authRate}%) - Sistema de autenticaci√≥n requiere atenci√≥n\n`;
    }

    report += `\n### üè† Funcionalidades Principales
`;

    const mainTests = testResults.details.filter(test => 
        test.test.toLowerCase().includes('propiedades') || 
        test.test.toLowerCase().includes('principal') || 
        test.test.toLowerCase().includes('dashboard')
    );

    const mainPassed = mainTests.filter(test => test.passed).length;
    const mainTotal = mainTests.length;
    const mainRate = mainTotal > 0 ? ((mainPassed / mainTotal) * 100).toFixed(1) : 0;

    if (mainRate >= 80) {
        report += `‚úÖ **OPERATIVO** (${mainRate}%) - Funcionalidades principales funcionando\n`;
    } else {
        report += `‚ùå **PROBLEMAS** (${mainRate}%) - Funcionalidades principales requieren atenci√≥n\n`;
    }

    report += `\n## üöÄ PR√ìXIMOS PASOS

`;

    if (testResults.failed === 0) {
        report += `‚úÖ **PLATAFORMA LISTA PARA PRODUCCI√ìN**
- Todos los tests pasaron exitosamente
- Sistema de autenticaci√≥n operativo
- Funcionalidades principales funcionando
- Listo para deployment final

`;
    } else {
        report += `üîß **CORRECCIONES REQUERIDAS**
- Resolver ${testResults.failed} problemas identificados
- Verificar configuraci√≥n de Supabase si hay errores de autenticaci√≥n
- Re-ejecutar testing despu√©s de correcciones

`;
    }

    report += `## üìû SOPORTE

Si persisten problemas:
1. Verificar que el servidor est√© ejecut√°ndose en localhost:3000
2. Confirmar configuraci√≥n de variables de entorno
3. Revisar logs del servidor para errores espec√≠ficos
4. Ejecutar \`npm run dev\` para reiniciar el servidor

---

**Generado autom√°ticamente el ${timestamp}**
`;

    return report;
}

// Ejecutar testing si se llama directamente
if (require.main === module) {
    runExhaustiveTesting().catch(console.error);
}

module.exports = { runExhaustiveTesting, testResults };
